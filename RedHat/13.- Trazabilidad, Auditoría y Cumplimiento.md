# 13. Trazabilidad, Auditoría y Cumplimiento

La trazabilidad y auditoría son pilares esenciales en entornos empresariales y de gobierno, donde es necesario **registrar, analizar y conservar evidencia** de las acciones realizadas sobre los sistemas. En RHEL, estas tareas se gestionan mediante herramientas como **logrotate** y **auditd**.

---

## 13.1 Logrotate

### Finalidad

Administrar la rotación, compresión y eliminación de archivos de log para evitar que saturen el almacenamiento y mantener registros históricos ordenados.

**Archivo de configuración principal:**

```
/etc/logrotate.conf
```

**Directorio adicional:**

```
/etc/logrotate.d/
```

Cada archivo en este directorio define políticas específicas para aplicaciones individuales.

### Ejemplo de configuración personalizada

```
/var/log/httpd/*.log {
    weekly
    rotate 4
    compress
    missingok
    notifempty
}
```

**Explicación de directivas:**

| Directiva    | Función                                     |
| ------------ | ------------------------------------------- |
| `weekly`     | Rota los logs cada semana.                  |
| `rotate 4`   | Conserva cuatro archivos históricos.        |
| `compress`   | Comprime los archivos antiguos usando gzip. |
| `missingok`  | Ignora errores si el archivo no existe.     |
| `notifempty` | No rota si el archivo está vacío.           |

**Forzar rotación manual:**

```bash
logrotate -f /etc/logrotate.conf
```

**Verificar rotación simulada:**

```bash
logrotate -d /etc/logrotate.conf
```

**Casos de uso comunes:**

* Rotación de logs de Apache, Nginx o journald.
* Control de crecimiento de archivos en `/var/log/messages` y `/var/log/secure`.
* Integración con scripts de respaldo para conservar logs comprimidos.

**Buenas prácticas:**

* Revisar permisos de `/var/log` y sus subdirectorios.
* Mantener políticas de retención alineadas con auditorías de seguridad.
* Automatizar la ejecución mediante cron (`/etc/cron.daily/logrotate`).

---

## 13.2 Auditd (Sistema de Auditoría de Linux)

### Finalidad

El servicio **auditd** registra eventos críticos del sistema, como accesos, cambios de permisos, ejecución de binarios o modificaciones en archivos de configuración. Cumple con estándares de trazabilidad (ISO 27001, PCI-DSS, HIPAA, etc.).

**Activar y habilitar:**

```bash
systemctl enable auditd
systemctl start auditd
```

**Verificar estado:**

```bash
systemctl status auditd
```

**Archivo principal de configuración:**

```
/etc/audit/auditd.conf
```

**Ubicación de logs:**

```
/var/log/audit/audit.log
```

---

### Monitorear archivo sensible

```bash
auditctl -w /etc/passwd -p wa -k passwd_changes
```

**Explicación:**

* `-w /etc/passwd`: establece vigilancia sobre el archivo `/etc/passwd`.
* `-p wa`: monitorea eventos de escritura (w) y cambios de atributos (a).
* `-k passwd_changes`: etiqueta la regla para rastreo en reportes posteriores.

**Visualizar reglas activas:**

```bash
auditctl -l
```

**Eliminar regla:**

```bash
auditctl -W /etc/passwd -p wa -k passwd_changes
```

---

### Ver reportes por clave

```bash
aureport -k
```

**Interpretación:** muestra todos los eventos asociados con la clave `passwd_changes`, permitiendo rastrear quién, cuándo y cómo se realizaron cambios en el archivo.

**Ejemplo práctico:**

```bash
aureport -f | grep "/etc/passwd"
ausearch -k passwd_changes --success no
```

**Usos comunes:**

* Auditoría de accesos administrativos.
* Control de integridad sobre configuraciones críticas.
* Cumplimiento de normativas de seguridad y trazabilidad.

---

### Configuración avanzada de reglas persistentes

Agregar reglas personalizadas en:

```
/etc/audit/rules.d/audit.rules
```

Ejemplo:

```
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /var/log/secure -p r -k access_logs
```

Aplicar los cambios:

```bash
auditctl -R /etc/audit/rules.d/audit.rules
```

---

### Integración con SELinux y Systemd

Auditd se complementa con **SELinux**, registrando violaciones de políticas en `/var/log/audit/audit.log` bajo eventos `AVC`. También se integra con **systemd-journald**, permitiendo correlación de eventos de seguridad a través de `journalctl`.

**Consulta combinada:**

```bash
ausearch -m avc -ts today | aureport -avc --summary
```

---

### Buenas Prácticas de Auditoría

* Configurar rotación automática de `/var/log/audit/audit.log` mediante logrotate.
* Monitorear uso de espacio en disco (`ausearch --input-logs`).
* Centralizar logs con `rsyslog` o `journald` remoto.
* Revisar auditorías regularmente (`aureport`, `ausearch`).
* Implementar alertas automáticas (por ejemplo, envío de correo al detectar cambios en `/etc/passwd`).

---

### Glosario

| Término        | Descripción                                                         |
| -------------- | ------------------------------------------------------------------- |
| **Logrotate**  | Herramienta que rota y comprime logs automáticamente.               |
| **auditd**     | Demonio de auditoría que registra eventos críticos del sistema.     |
| **aureport**   | Genera reportes resumidos de eventos auditados.                     |
| **ausearch**   | Filtra y busca eventos específicos dentro de los logs de auditoría. |
| **Clave (-k)** | Etiqueta usada para identificar grupos de eventos relacionados.     |

---

### Referencias

* Red Hat Enterprise Linux 9 – Security, Compliance and Audit Guide
  [https://access.redhat.com/documentation/en-us/](https://access.redhat.com/documentation/en-us/)
* Auditd User Guide: [https://linux.die.net/man/8/auditd](https://linux.die.net/man/8/auditd)
* Logrotate Documentation: [https://linux.die.net/man/8/logrotate](https://linux.die.net/man/8/logrotate)
