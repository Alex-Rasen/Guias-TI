# 10. Respaldos y Restauraciones

El respaldo de datos es una práctica crítica para garantizar la continuidad operativa y la recuperación ante fallos o errores humanos. En sistemas RHEL y derivados, existen múltiples herramientas para realizar copias de seguridad manuales o automatizadas, desde utilidades básicas como `tar` y `rsync` hasta soluciones empresariales.

---

## 10.1 Copias de Seguridad Manuales

Las copias manuales se utilizan cuando se desea resguardar información antes de una actualización, mantenimiento o migración de sistema.

### Ejemplo con `tar`

```bash
tar -czf backup_etc_$(date +%F).tar.gz /etc
```

**Explicación:**

* `tar`: herramienta estándar para empaquetar y comprimir archivos.
* `-c`: crea un nuevo archivo.
* `-z`: aplica compresión gzip.
* `-f`: define el nombre del archivo de salida.
* `$(date +%F)`: inserta la fecha actual en el nombre (formato AAAA-MM-DD).

**Resultado:** se genera un archivo como `backup_etc_2025-10-17.tar.gz` que contiene todo el contenido de `/etc`.

**Verificación del contenido:**

```bash
tar -tzf backup_etc_2025-10-17.tar.gz | head
```

**Ventaja:** fácil de transportar y restaurar, ideal para respaldos de configuración.

---

### Ejemplo con `rsync`

```bash
rsync -av /home /mnt/backup/
```

**Parámetros:**

* `-a`: modo archivo (preserva permisos, enlaces simbólicos, tiempos, dueños, etc.).
* `-v`: modo verboso (muestra el progreso de la operación).

**Uso:** copia incremental que sincroniza el contenido de `/home` hacia `/mnt/backup/`, copiando solo los cambios.

**Ejemplo avanzado (excluyendo directorios temporales):**

```bash
rsync -av --exclude='*.tmp' /var/www/ /mnt/backup/www/
```

**Ventajas de rsync:**

* Sincronización diferencial (solo copia archivos nuevos o modificados).
* Soporte para transferencias remotas vía SSH (`rsync -av -e ssh`).
* Ideal para tareas automatizadas y scripts.

---

## 10.2 Respaldos Automatizados con Cron

El demonio **cron** permite ejecutar comandos y scripts de forma programada. Es ideal para automatizar tareas de respaldo periódico.

### Crear tarea programada

```bash
crontab -e
```

Agregar la línea:

```
0 3 * * * /usr/bin/rsync -a /home /mnt/backup/home
```

**Explicación de la sintaxis:**

| Campo            | Descripción       | Ejemplo              |
| ---------------- | ----------------- | -------------------- |
| Minuto           | (0–59)            | `0`                  |
| Hora             | (0–23)            | `3`                  |
| Día del mes      | (1–31)            | `*` (todos)          |
| Mes              | (1–12)            | `*` (todos)          |
| Día de la semana | (0–6)             | `*` (todos)          |
| Comando          | Acción a ejecutar | `/usr/bin/rsync ...` |

**Interpretación:** todos los días a las **03:00 AM** ejecutará el respaldo de `/home` hacia `/mnt/backup/home`.

**Ver tareas programadas:**

```bash
crontab -l
```

**Recomendaciones:**

* Redirigir salida y errores a un log:

  ```bash
  0 3 * * * /usr/bin/rsync -a /home /mnt/backup/home >> /var/log/backup.log 2>&1
  ```
* Comprobar permisos de escritura en el destino.
* Mantener respaldos por fechas (`/mnt/backup/$(date +%F)/`).

---

## 10.3 Restauraciones

Las restauraciones permiten recuperar configuraciones o datos en caso de pérdida, corrupción o error humano.

### Restaurar con `tar`

```bash
tar -xzf backup_etc_2025-10-11.tar.gz -C /
```

**Explicación:**

* `-x`: extrae archivos.
* `-z`: descomprime gzip.
* `-f`: usa archivo especificado.
* `-C /`: descomprime en la raíz del sistema (ubicación original).

**Buenas prácticas:**

* Verificar el contenido antes de sobrescribir archivos existentes:

  ```bash
  tar -tzf backup_etc_2025-10-11.tar.gz | less
  ```
* Asegurarse de que no haya procesos modificando los archivos durante la restauración.

---

### Restaurar con `rsync`

```bash
rsync -av /mnt/backup/home/ /home/
```

**Finalidad:** sincroniza el contenido del respaldo hacia su ubicación original.

**Opciones útiles:**

* `--delete`: elimina archivos en destino que ya no existen en la fuente.
* `--dry-run`: simula la restauración sin hacer cambios.

**Ejemplo seguro:**

```bash
rsync -av --dry-run /mnt/backup/home/ /home/
```

**Ventajas:**

* Permite restaurar de forma selectiva o incremental.
* Mantiene permisos y estructura exacta.

---

### Buenas Prácticas Generales de Respaldo

* Realizar pruebas periódicas de restauración (validar integridad del respaldo).
* Almacenar respaldos en ubicaciones externas (disco externo, servidor remoto, nube privada).
* En sistemas críticos, implementar rotación de copias (diaria, semanal, mensual).
* Proteger respaldos con permisos restrictivos o cifrado (por ejemplo, `gpg` o `encfs`).
* Documentar rutas, horarios y procedimientos de respaldo en bitácoras.

---

### Ejemplo de Script Completo Automatizado

```bash
#!/bin/bash
# /usr/local/bin/backup_daily.sh
FECHA=$(date +%F)
DESTINO="/mnt/backup/$FECHA"
mkdir -p "$DESTINO"
rsync -a --delete /etc /home /var/www "$DESTINO" >> /var/log/backup.log 2>&1
echo "Backup completado el $FECHA" >> /var/log/backup.log
```

**Agregar al cron:**

```
0 2 * * * /usr/local/bin/backup_daily.sh
```

---

### Glosario

* **tar:** herramienta de empaquetado y compresión.
* **rsync:** herramienta de sincronización incremental.
* **cron:** planificador de tareas en UNIX/Linux.
* **snapshot:** copia instantánea de datos, usada frecuentemente con LVM.
* **incremental:** respaldo que solo guarda los cambios desde el último backup.

---

### Referencias

* Red Hat Enterprise Linux 9 System Administrator Guide – Data Backup and Recovery
  [https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/)
* `man tar`, `man rsync`, `man crontab`
* Rsync documentation: [https://download.samba.org/pub/rsync/rsync.html](https://download.samba.org/pub/rsync/rsync.html)
