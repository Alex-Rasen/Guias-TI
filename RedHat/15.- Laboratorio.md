# 15. Laboratorio Integral RHEL 8+: Implementación, Configuración y Automatización Completa

Este laboratorio tiene como objetivo aplicar de manera **práctica y secuencial todos los contenidos abordados** en los módulos previos (1–14), consolidando las competencias necesarias para administrar, asegurar, optimizar y automatizar un entorno empresarial basado en **Red Hat Enterprise Linux 8+**.
Cada actividad se construye sobre la anterior, simulando un escenario real de implementación de infraestructura IT en una organización.

---

## 15.1 Preparación del Entorno

**Objetivo:** desplegar un entorno base con acceso remoto, usuarios administrativos y estructura de almacenamiento.

**Requisitos:**

* Dos servidores virtuales RHEL 8 o superior (`server1` y `server2`).
* Conectividad SSH entre ambos.
* Usuario administrativo con privilegios `sudo`.

### Tareas

1. Instalar y habilitar SSH (`dnf install openssh-server -y`).
2. Configurar acceso mediante clave pública (`ssh-keygen` + `ssh-copy-id`).
3. Crear usuarios `admin1`, `dev1` y `soporte`.
4. Asignar privilegios a `admin1` vía grupo `wheel` y sudoers.
5. Configurar un banner de acceso en `/etc/issue` con el nombre de la empresa.

**Verificación:** conexión SSH desde `server2` hacia `server1` sin contraseña.

---

## 15.2 Gestión de Usuarios y Permisos

**Objetivo:** aplicar políticas de control de acceso seguras.

1. Crear grupo `operaciones` y agregar `soporte` y `dev1`.
2. Configurar permisos en `/srv/proyectos`:

   ```bash
   mkdir -p /srv/proyectos
   chown root:operaciones /srv/proyectos
   chmod 2770 /srv/proyectos
   ```
3. Asignar ACL para permitir que `dev1` tenga escritura total en `/srv/proyectos/docs`.

   ```bash
   setfacl -m u:dev1:rwx /srv/proyectos/docs
   ```
4. Configurar `sudoers` para permitir a `soporte` reiniciar servicios de red únicamente:

   ```
   soporte ALL=(ALL) /usr/bin/systemctl restart NetworkManager
   ```

**Verificación:** listar ACL y ejecutar el reinicio con `sudo` desde la cuenta `soporte`.

---

## 15.3 Sistemas de Archivos y Almacenamiento

**Objetivo:** administrar discos, particiones y volúmenes lógicos.

1. Crear y montar una nueva partición en `/dev/sdb` de 10 GB:

   ```bash
   parted /dev/sdb mklabel gpt
   parted /dev/sdb mkpart primary ext4 1MiB 10GiB
   mkfs.ext4 /dev/sdb1
   mkdir /mnt/datos
   mount /dev/sdb1 /mnt/datos
   ```
2. Configurar montaje permanente en `/etc/fstab`.
3. Crear un grupo de volúmenes `vg_datos` y un volumen lógico `lv_backup` de 5 GB.
4. Montar el volumen en `/mnt/backup` y configurar LUKS para cifrarlo.
5. Crear un snapshot de respaldo antes de ampliar su tamaño.

**Verificación:** `lsblk`, `df -h`, `lvs`, `cryptsetup status`.

---

## 15.4 Configuración de Red

**Objetivo:** establecer conectividad, DNS y firewall.

1. Configurar interfaz `eth0` con IP estática usando `nmcli`:

   ```bash
   nmcli con add type ethernet ifname eth0 con-name LAN ipv4.addresses 192.168.10.10/24 ipv4.gateway 192.168.10.1 ipv4.dns 8.8.8.8 ipv4.method manual
   nmcli con up LAN
   ```
2. Cambiar hostname a `server1.local`.
3. Habilitar servicios HTTP y SSH en el firewall.

   ```bash
   firewall-cmd --zone=public --add-service=http --permanent
   firewall-cmd --zone=public --add-service=ssh --permanent
   firewall-cmd --reload
   ```

**Verificación:** `ping`, `nmcli device status`, `firewall-cmd --list-all`.

---

## 15.5 Servicios del Sistema y Logs

**Objetivo:** administrar servicios, analizar logs y mantener el sistema limpio.

1. Habilitar y verificar `httpd` con `systemctl`.
2. Revisar logs con `journalctl -u httpd` y `tail -f /var/log/messages`.
3. Configurar `logrotate` personalizado para `/var/log/httpd/*.log`.
4. Habilitar `auditd` y crear regla para `/etc/passwd`.

**Verificación:** generar evento de auditoría y revisarlo con `aureport -k`.

---

## 15.6 Monitoreo de Recursos

**Objetivo:** evaluar rendimiento del sistema.

1. Instalar herramientas:

   ```bash
   dnf install sysstat nmon -y
   ```
2. Monitorear CPU y E/S:

   ```bash
   vmstat 2
   iostat -x 2
   sar -u 2 5
   ```
3. Detectar cuellos de botella de CPU con `top` y memoria con `free -h`.
4. Configurar `node_exporter` para Prometheus.

**Verificación:** visualizar métricas desde `http://server1:9100/metrics`.

---

## 15.7 Seguridad y Endurecimiento (Hardening)

**Objetivo:** proteger el servidor mediante políticas de seguridad.

1. Activar SELinux en modo `enforcing`.
2. Configurar SSH para uso de claves, puerto 2222 y sin login root.
3. Aplicar política de contraseñas seguras (`/etc/security/pwquality.conf`).
4. Instalar y configurar AIDE:

   ```bash
   dnf install aide -y
   aide --init
   mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
   aide --check
   ```

**Verificación:** revisar logs de SELinux (`ausearch -m avc -ts today`).

---

## 15.8 Automatización con Ansible

**Objetivo:** desplegar configuraciones remotas en varios nodos.

1. Instalar Ansible en `server1`.
2. Configurar inventario `/etc/ansible/hosts` con `server2`.
3. Probar conexión `ansible all -m ping`.
4. Crear playbook `apache.yml` para instalar y configurar Apache en `server2`.
5. Implementar un *handler* que reinicie Apache solo si cambia la configuración.

**Verificación:** `curl http://server2` muestra página de prueba.

---

## 15.9 Arranque, Optimización y Automatización Local

**Objetivo:** mejorar rendimiento y automatizar tareas recurrentes.

1. Revisar tiempos de arranque (`systemd-analyze blame`).
2. Deshabilitar servicios innecesarios (`systemctl disable bluetooth.service`).
3. Aplicar perfil de rendimiento con `tuned-adm profile throughput-performance`.
4. Crear script `/usr/local/bin/cleanup.sh`:

   ```bash
   #!/bin/bash
   find /tmp -type f -mtime +5 -delete
   ```
5. Programar su ejecución diaria con systemd timer.

**Verificación:** `systemctl list-timers` muestra `cleanup.timer` activo.

---

## 15.10 Clustering y Alta Disponibilidad (Opcional)

**Objetivo:** implementar cluster HA con Pacemaker/Corosync (avanzado).

1. Instalar paquetes:

   ```bash
   dnf install pacemaker corosync pcs -y
   systemctl enable --now pcsd
   ```
2. Autenticar nodos y crear cluster `cluster01`:

   ```bash
   pcs cluster auth server1 server2
   pcs cluster setup --name cluster01 server1 server2
   pcs cluster start --all
   ```
3. Agregar recurso IP virtual y servicio Apache:

   ```bash
   pcs resource create WebIP ocf:heartbeat:IPaddr2 ip=192.168.10.50 cidr_netmask=24 op monitor interval=30s
   pcs resource create WebSrv ocf:heartbeat:apache configfile=/etc/httpd/conf/httpd.conf op monitor interval=1min
   pcs constraint colocation add WebSrv WebIP INFINITY
   pcs constraint order WebIP then WebSrv
   ```

**Verificación:** `pcs status` muestra recursos activos y failover funcional.

---

## 15.11 Respaldos y Recuperación

**Objetivo:** implementar políticas de respaldo y restauración.

1. Crear script de respaldo diario con `tar` y `rsync`.
2. Programar con `cron` o `timer`.
3. Simular pérdida de `/etc` y restaurar desde copia.

**Verificación:** comprobar integridad post-restauración.

---

## 15.12 Evaluación Final

**Entrega:**

* Bitácora con capturas y logs de cada etapa.
* Scripts, playbooks y configuraciones creadas.
* Validación de servicios en funcionamiento.

**Criterios:**

* Aplicación coherente de conceptos.
* Configuración segura y funcional.
* Documentación clara del proceso.

---

### Resultado Esperado

Un entorno RHEL completamente configurado, seguro, optimizado y automatizado, cumpliendo con las mejores prácticas de administración Linux empresarial.
