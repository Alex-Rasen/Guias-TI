# 8. Automatización con Ansible

Ansible es una herramienta de **automatización IT sin agentes (agentless)** que permite configurar servidores, desplegar aplicaciones y orquestar infraestructuras completas utilizando una sintaxis simple basada en YAML. Su filosofía se centra en la **idempotencia**, asegurando que las operaciones solo se ejecuten si es necesario.

---

## 8.1 Introducción a Ansible

**Características principales:**

* No requiere instalar agentes en los nodos gestionados (usa SSH o WinRM).
* Lenguaje declarativo basado en YAML.
* Compatible con Linux, Windows y dispositivos de red.
* Estructura modular mediante *roles* y *playbooks*.

**Casos de uso:**

* Configuración de servidores (web, bases de datos, proxy, etc.).
* Despliegue continuo (CI/CD).
* Orquestación de infraestructura en entornos híbridos.

**Arquitectura básica:**

* **Control Node:** máquina donde se ejecutan los playbooks.
* **Managed Nodes:** equipos gestionados mediante SSH.
* **Inventory:** lista de hosts o grupos de servidores.

---

## 8.2 Instalación y Configuración

Instalar Ansible en RHEL o derivados:

```bash
dnf install ansible -y
```

Archivo de inventario principal:

```
/etc/ansible/hosts
```

**Ejemplo de inventario:**

```ini
[web]
192.168.10.10 ansible_user=root
192.168.10.11 ansible_user=root
```

Verificar conectividad:

```bash
ansible all -m ping
```

**Salida esperada:**

```
192.168.10.10 | SUCCESS => {
  "changed": false,
  "ping": "pong"
}
```

---

## 8.3 Estructura de un Playbook

Los *playbooks* son archivos YAML que describen el estado deseado del sistema.

**Ejemplo básico:**

```yaml
- name: Instalar y configurar Apache
  hosts: web
  become: yes
  tasks:
    - name: Instalar httpd
      dnf:
        name: httpd
        state: present

    - name: Iniciar servicio
      service:
        name: httpd
        state: started
        enabled: yes

    - name: Copiar archivo index
      copy:
        src: files/index.html
        dest: /var/www/html/index.html
```

Ejecutar el playbook:

```bash
ansible-playbook apache.yml
```

---

## 8.4 Variables y Plantillas (Jinja2)

Las variables permiten parametrizar configuraciones. Las plantillas Jinja2 generan archivos dinámicos.

**Ejemplo:**
Archivo de variables (`vars.yml`):

```yaml
server_port: 8080
server_name: webserver.local
```

Plantilla (`templates/httpd.conf.j2`):

```
Listen {{ server_port }}
ServerName {{ server_name }}
```

Tarea en playbook:

```yaml
- name: Generar archivo de configuración
  template:
    src: templates/httpd.conf.j2
    dest: /etc/httpd/conf/httpd.conf
```

---

## 8.5 Roles en Ansible

Los roles permiten estructurar playbooks complejos en módulos reutilizables.

**Estructura estándar:**

```
roles/
  apache/
    tasks/main.yml
    handlers/main.yml
    templates/httpd.conf.j2
    files/index.html
    vars/main.yml
```

Ejemplo de `roles/apache/tasks/main.yml`:

```yaml
- name: Instalar Apache
  dnf:
    name: httpd
    state: present

- name: Copiar página principal
  copy:
    src: index.html
    dest: /var/www/html/index.html
```

Playbook que usa el rol:

```yaml
- hosts: web
  become: yes
  roles:
    - apache
```

---

## 8.6 Módulos Comunes de Ansible

| Módulo     | Función                          | Ejemplo                                                            |
| ---------- | -------------------------------- | ------------------------------------------------------------------ |
| `dnf`      | Instala o elimina paquetes.      | `dnf: name=nginx state=present`                                    |
| `service`  | Controla servicios systemd.      | `service: name=nginx state=restarted`                              |
| `copy`     | Copia archivos al nodo remoto.   | `copy: src=file.txt dest=/tmp/`                                    |
| `template` | Genera archivos con variables.   | `template: src=config.j2 dest=/etc/config`                         |
| `user`     | Crea o elimina usuarios.         | `user: name=juan state=present`                                    |
| `file`     | Crea carpetas o cambia permisos. | `file: path=/backup state=directory mode=0755`                     |
| `cron`     | Crea tareas programadas.         | `cron: name=backup minute=0 hour=3 job='/usr/local/bin/backup.sh'` |

---

## 8.7 Automatización Avanzada

**Ejemplo: configuración simultánea de red y firewall:**

```yaml
- name: Configurar red y firewall
  hosts: all
  become: yes
  tasks:
    - name: Configurar hostname
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Abrir puerto 80
      firewalld:
        port: 80/tcp
        permanent: yes
        state: enabled
        immediate: yes
```

**Resultado:** todos los servidores del grupo aplican la misma configuración automáticamente.

---

## 8.8 Uso de Handlers

Los *handlers* son tareas que solo se ejecutan cuando una acción previa genera un cambio.

**Ejemplo:**

```yaml
- name: Copiar archivo de configuración
  copy:
    src: config.conf
    dest: /etc/myapp/config.conf
  notify: Reiniciar servicio

handlers:
  - name: Reiniciar servicio
    service:
      name: myapp
      state: restarted
```

---

## 8.9 Ejemplo Completo de Despliegue

```yaml
- name: Despliegue de aplicación completa
  hosts: web
  become: yes
  vars:
    app_dir: /var/www/html
  tasks:
    - name: Instalar dependencias
      dnf:
        name:
          - httpd
          - php
        state: present

    - name: Copiar aplicación
      copy:
        src: app/*
        dest: "{{ app_dir }}"

    - name: Configurar servicio Apache
      template:
        src: apache.conf.j2
        dest: /etc/httpd/conf.d/app.conf
      notify: Reiniciar Apache

  handlers:
    - name: Reiniciar Apache
      service:
        name: httpd
        state: restarted
```

---

## 8.10 Ejecución Selectiva y Validación

**Ejecutar tareas específicas:**

```bash
ansible-playbook setup.yml --tags "firewall"
```

**Modo simulación (dry-run):**

```bash
ansible-playbook setup.yml --check
```

**Ver salida detallada:**

```bash
ansible-playbook setup.yml -v
```

---

## 8.11 Buenas Prácticas

* Separar roles y variables en directorios estructurados.
* Versionar los playbooks con Git.
* Usar `ansible-lint` para validar sintaxis y estilo.
* Ejecutar en entornos de staging antes de producción.
* Documentar cada tarea (`name:` debe ser claro y descriptivo).
* Usar `become: yes` solo donde sea necesario.

---

### Glosario

* **Playbook:** conjunto de tareas ejecutadas en nodos.
* **Inventory:** lista de servidores y grupos gestionados.
* **Role:** estructura modular reutilizable.
* **Handler:** tarea que responde a eventos de cambio.
* **Module:** componente funcional (dnf, copy, template, etc.).

---

### Referencias

* Red Hat Ansible Automation Platform Documentation:
  [https://access.redhat.com/documentation/en-us/](https://access.redhat.com/documentation/en-us/)
* Ansible Docs: [https://docs.ansible.com/](https://docs.ansible.com/)
* YAML & Jinja2 Templates: [https://jinja.palletsprojects.com/](https://jinja.palletsprojects.com/)
