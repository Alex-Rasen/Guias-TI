# 12. Alta Disponibilidad y Clustering (Opcional)

La **alta disponibilidad (High Availability, HA)** busca eliminar puntos únicos de falla, garantizando que los servicios críticos continúen funcionando incluso ante fallas de hardware o software. En RHEL y derivados, esto se logra mediante herramientas como **Pacemaker**, **Corosync**, **PCS** y **DRBD**.

---

## 12.1 Conceptos Fundamentales

### Pacemaker / Corosync

* **Pacemaker:** es el gestor de recursos de alta disponibilidad que controla qué servicios deben ejecutarse y dónde.
* **Corosync:** provee el canal de comunicación entre nodos (mensajería y quorum).

**Objetivo:** si un nodo falla, Pacemaker transfiere automáticamente los recursos (IP virtual, servicios, discos) a otro nodo disponible.

### DRBD (Distributed Replicated Block Device)

DRBD replica datos a nivel de bloque entre dos o más servidores, de forma similar a RAID-1 sobre red. Permite mantener discos sincronizados en tiempo real.

**Ejemplo de uso:** sincronizar `/dev/sdb` entre `nodo1` y `nodo2` para garantizar consistencia en bases de datos o almacenamiento compartido.

**Componentes básicos de un cluster HA:**

| Componente                           | Función                                                                           |
| ------------------------------------ | --------------------------------------------------------------------------------- |
| Pacemaker                            | Gestión de recursos y decisiones de failover.                                     |
| Corosync                             | Comunicación, quorum y sincronización entre nodos.                                |
| PCS (Pacemaker Configuration System) | Interfaz para configurar y administrar clusters.                                  |
| DRBD                                 | Replicación de almacenamiento entre nodos.                                        |
| STONITH                              | Mecanismo de fencing que aísla nodos defectuosos para evitar corrupción de datos. |

---

## 12.2 Instalación Básica

Instalar los paquetes requeridos:

```bash
dnf install pacemaker corosync pcs -y
```

Habilitar y arrancar el servicio de administración:

```bash
systemctl enable pcsd
systemctl start pcsd
```

**Explicación:**

* `pacemaker`, `corosync`, `pcs`: componentes esenciales del cluster.
* `pcsd`: servicio que facilita la autenticación y configuración de los nodos.

Verificar el estado:

```bash
systemctl status pcsd
```

**Recomendación:** establecer contraseñas idénticas para el usuario `hacluster` en todos los nodos:

```bash
echo redhat | passwd --stdin hacluster
```

---

## 12.3 Configuración del Cluster

Autenticar y crear el cluster básico entre dos nodos:

```bash
pcs cluster auth nodo1 nodo2
pcs cluster setup --name cluster01 nodo1 nodo2
pcs cluster start --all
pcs status
```

### Explicación paso a paso

1. **Autenticación entre nodos:**

   ```bash
   pcs cluster auth nodo1 nodo2
   ```

   Establece confianza mutua entre los nodos del cluster mediante el usuario `hacluster`.

2. **Creación del cluster:**

   ```bash
   pcs cluster setup --name cluster01 nodo1 nodo2
   ```

   Define el nombre (`cluster01`) y los nodos participantes.

3. **Inicio del cluster:**

   ```bash
   pcs cluster start --all
   ```

   Inicia los servicios del cluster en todos los nodos configurados.

4. **Verificación del estado:**

   ```bash
   pcs status
   ```

   Muestra el estado del cluster, los nodos y los recursos activos.

**Salida esperada (ejemplo):**

```
Cluster name: cluster01
Stack: corosync
Current DC: nodo1 (version 2.1.5)
2 nodes configured
0 resource instances configured
```

---

## 12.4 Agregar Recursos al Cluster

Ejemplo: agregar un servicio Apache con IP virtual.

```bash
pcs resource create WebIP ocf:heartbeat:IPaddr2 ip=192.168.100.100 cidr_netmask=24 op monitor interval=30s
pcs resource create WebSrv ocf:heartbeat:apache configfile=/etc/httpd/conf/httpd.conf op monitor interval=1min
pcs constraint colocation add WebSrv WebIP INFINITY
pcs constraint order WebIP then WebSrv
```

**Explicación:**

* Crea un recurso IP virtual (`WebIP`) y un servicio Apache gestionado (`WebSrv`).
* Define reglas para que ambos se ejecuten en el mismo nodo y en orden.

Verificar configuración:

```bash
pcs status resources
```

---

## 12.5 DRBD Básico (Replicación de Datos)

Instalar el módulo:

```bash
dnf install drbd90-utils -y
```

Configurar el archivo `/etc/drbd.conf`:

```bash
resource r0 {
  on nodo1 {
    device /dev/drbd0;
    disk /dev/sdb1;
    address 192.168.10.1:7788;
    meta-disk internal;
  }
  on nodo2 {
    device /dev/drbd0;
    disk /dev/sdb1;
    address 192.168.10.2:7788;
    meta-disk internal;
  }
}
```

Sincronizar y activar:

```bash
drbdadm create-md r0
systemctl enable drbd
systemctl start drbd
drbdadm -- --overwrite-data-of-peer primary r0
```

**Resultado:** ambos nodos tendrán discos sincronizados en tiempo real.

---

## 12.6 Monitoreo y Mantenimiento

**Comandos útiles:**

| Comando                          | Descripción                                 |
| -------------------------------- | ------------------------------------------- |
| `pcs status`                     | Muestra el estado del cluster y recursos.   |
| `crm_mon -1`                     | Visualiza estado en formato resumen.        |
| `pcs cluster stop nodo2`         | Detiene un nodo.                            |
| `pcs resource move WebSrv nodo1` | Migra manualmente un recurso.               |
| `pcs stonith show`               | Lista dispositivos de fencing configurados. |

**Logs relevantes:**

* `/var/log/pacemaker.log`
* `/var/log/corosync/corosync.log`

---

### Buenas Prácticas

* Mantener sincronizados los relojes con `chronyd` o `ntpd`.
* Configurar `STONITH` para evitar corrupción de datos.
* Realizar pruebas de failover antes de producción.
* Asegurar las comunicaciones entre nodos mediante red privada.
* Documentar recursos y dependencias en el cluster.

---

### Glosario

* **Cluster:** conjunto de nodos que actúan como un único sistema.
* **Failover:** transferencia automática de un servicio a otro nodo.
* **STONITH:** mecanismo que apaga o aísla nodos defectuosos.
* **DRBD:** replicación de bloques en red (Network RAID-1).
* **Quorum:** cantidad mínima de nodos activos necesarios para operar.

---

### Referencias

* Red Hat High Availability Add-On Administration Guide
  [https://access.redhat.com/documentation/en-us/](https://access.redhat.com/documentation/en-us/)
* ClusterLabs Documentation: [https://clusterlabs.org/](https://clusterlabs.org/)
* DRBD User’s Guide: [https://docs.linbit.com/](https://docs.linbit.com/)
