# 4. Almacenamiento y Particiones

El almacenamiento en Linux se basa en una arquitectura jerárquica flexible que permite administrar discos físicos, volúmenes lógicos, sistemas de archivos y puntos de montaje. Comprender estos componentes es fundamental para optimizar el rendimiento, ampliar espacio y garantizar la integridad de los datos.

---

## 4.1 Particionado de Discos

### Finalidad

Preparar discos nuevos o reorganizar los existentes para asignar espacio a particiones, que luego serán formateadas con un sistema de archivos.

### Ver discos disponibles

```bash
lsblk
```

**Explicación:**

* `lsblk` muestra la jerarquía de dispositivos de bloque, sus particiones y puntos de montaje.
* Permite identificar el nombre del disco (ej. `/dev/sda`, `/dev/sdb`) antes de modificarlo.

**Ejemplo de salida:**

```
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda           8:0    0  100G  0 disk
├─sda1        8:1    0   50G  0 part /
└─sda2        8:2    0   50G  0 part /home
```

---

### Crear partición con `fdisk`

```bash
fdisk /dev/sdb
```

**Flujo de trabajo:**

1. Presiona `n` para crear nueva partición.
2. Elige tipo **primaria** (p).
3. Define el tamaño, por ejemplo `+10G`.
4. Guarda con `w` para aplicar cambios.

**Nota:** `fdisk` usa esquema **MBR**, adecuado para discos menores a 2 TB.

---

### Crear partición con `parted`

```bash
parted /dev/sdb mklabel gpt
parted /dev/sdb mkpart primary ext4 1MiB 10GiB
```

**Explicación:**

* **GPT (GUID Partition Table)**: reemplaza a MBR, soporta discos >2 TB y más de 4 particiones primarias.
* **mkpart**: crea la partición indicando tipo, sistema de archivos y tamaño.

**Caso de uso:** recomendado para sistemas modernos, servidores y entornos virtualizados.

---

## 4.2 Formateo de Particiones

### Finalidad

Aplicar un sistema de archivos a una partición antes de montarla.

```bash
mkfs.ext4 /dev/sdb1
```

* Crea un sistema de archivos **ext4**, el estándar más usado por su equilibrio entre rendimiento y estabilidad.

```bash
mkfs.xfs /dev/sdb2
```

* **XFS:** optimizado para volúmenes grandes y paralelismo I/O, usado por defecto en RHEL y derivados.

**Montaje temporal:**

```bash
mount /dev/sdb1 /mnt/datos
```

**Persistencia:** agregar en `/etc/fstab`:

```
/dev/sdb1  /mnt/datos  ext4  defaults  0  0
```

**Verificar montaje:**

```bash
df -hT /mnt/datos
```

---

## 4.3 Aumentar Tamaño de una Partición Existente (LVM)

**LVM (Logical Volume Manager)** permite administrar el espacio en disco de forma dinámica, sin necesidad de reiniciar o desmontar.

### Verificar espacio libre en el grupo de volúmenes (VG)

```bash
vgs
```

### Extender el volumen lógico (LV)

```bash
lvextend -r -L +5G /dev/vg_datos/lv_backup
```

**Explicación:**

* `-L +5G` agrega 5 GB.
* `-r` redimensiona automáticamente el sistema de archivos.

**Verificar:**

```bash
df -h /mnt/backup
```

**Ejemplo:**

* Antes: 10 GB.
* Después del comando: 15 GB.

---

## 4.4 Cifrado de Discos con LUKS

### Finalidad

Proteger datos sensibles mediante cifrado a nivel de bloque.

```bash
cryptsetup luksFormat /dev/sdb1
cryptsetup open /dev/sdb1 secure_disk
mkfs.ext4 /dev/mapper/secure_disk
mount /dev/mapper/secure_disk /mnt/secure
```

**Etapas:**

1. `luksFormat`: inicializa el cifrado LUKS.
2. `open`: desbloquea la partición y crea un dispositivo mapeado.
3. `mkfs`: aplica un sistema de archivos.
4. `mount`: monta el volumen cifrado.

**Consideraciones:**

* La clave se solicita en el arranque si se configura en `/etc/crypttab`.
* Compatible con fstab para montaje automático posterior al desbloqueo.

**Ejemplo de persistencia:**

```
secure_disk  /dev/sdb1  none  luks
```

---

## 4.5 Snapshots en LVM

### Finalidad

Crear copias instantáneas de un volumen para respaldo o pruebas.

```bash
lvcreate -L1G -s -n snap_backup /dev/vg_datos/lv_backup
```

**Explicación:**

* `-s` indica snapshot.
* `-L1G` asigna 1 GB para cambios diferenciales.

**Restaurar snapshot:**

```bash
lvconvert --merge /dev/vg_datos/snap_backup
```

**Caso práctico:**
Realizar una copia antes de actualizar una base de datos. Si algo falla, revertir al estado anterior.

---

## 4.6 Expansión de Almacenamiento Físico

### Escenario

Agregar un nuevo disco `/dev/sdc` a un grupo LVM existente.

```bash
pvcreate /dev/sdc
vgextend vg_datos /dev/sdc
lvextend -L +10G /dev/vg_datos/lv_backup
xfs_growfs /mnt/backup
```

**Explicación paso a paso:**

1. `pvcreate`: inicializa el disco como volumen físico.
2. `vgextend`: agrega el disco al grupo de volúmenes.
3. `lvextend`: amplía el volumen lógico.
4. `xfs_growfs`: expande el sistema de archivos XFS sin desmontar.

**Ventaja:** ampliación en caliente, sin interrupción del servicio.

---

## 4.7 Comprobación y Reparación de Sistemas de Archivos

### Finalidad

Verificar la integridad y reparar errores de sistemas de archivos.

**Para EXT4:**

```bash
e2fsck -f /dev/sdb1
```

* Escanea y corrige errores lógicos o de metadatos.

**Para XFS:**

```bash
xfs_repair /dev/sdb1
```

* Verifica estructura del sistema de archivos XFS.

**Recomendaciones:**

* Ejecutar solo sobre particiones desmontadas.
* Hacer copia de seguridad previa.
* Usar `-n` para modo de prueba sin aplicar cambios.

---

### Buenas Prácticas Generales

* Etiquetar particiones con `e2label` o `xfs_admin -L` para identificarlas en `/etc/fstab`.
* Monitorear espacio libre con `df -h` y `lvs`.
* Automatizar respaldos de LVM con scripts de snapshot.
* En servidores de producción, evitar modificar particiones en uso.

---

### Glosario

* **LVM:** Administrador de volúmenes lógicos que permite redimensionar particiones dinámicamente.
* **PV (Physical Volume):** disco o partición física.
* **VG (Volume Group):** conjunto de PV combinados.
* **LV (Logical Volume):** partición virtual asignada al sistema de archivos.
* **LUKS:** Estándar de cifrado de discos en Linux.
* **Snapshot:** copia instantánea de un volumen para restaurar rápidamente.

---

### Referencias

* Red Hat Enterprise Linux Storage Administration Guide:
  [https://access.redhat.com/documentation/en-us/](https://access.redhat.com/documentation/en-us/)
* LVM2 Manual Pages: `man lvm`, `man lvcreate`, `man vgextend`
* cryptsetup Documentation: [https://gitlab.com/cryptsetup/cryptsetup](https://gitlab.com/cryptsetup/cryptsetup)
