# 6. Configuraciones del Sistema / Servicios

La configuración y gestión de servicios es esencial para mantener la estabilidad y disponibilidad de un sistema Linux. A partir de RHEL 7, **systemd** reemplazó a los sistemas tradicionales como SysVinit, proporcionando una administración unificada de servicios, logs, sesiones y dependencias.

---

## 6.1 systemd y Servicios

### Introducción a systemd

**systemd** es el sistema de inicio (init system) que controla el arranque, la ejecución de servicios y la administración de procesos. Introduce conceptos como *unidades* (units), *targets*, *sockets* y *timers*.

Cada servicio, dispositivo o montaje se define mediante un archivo `.service`, `.socket`, `.mount` o `.timer` ubicado en:

```
/usr/lib/systemd/system/
/etc/systemd/system/
```

### Comandos Básicos

| Acción                | Descripción                                                       | Comando                        | Ejemplo                  |
| --------------------- | ----------------------------------------------------------------- | ------------------------------ | ------------------------ |
| Iniciar un servicio   | Activa el servicio en la sesión actual.                           | `systemctl start <servicio>`   | `systemctl start nginx`  |
| Habilitar al inicio   | Lo configura para iniciar automáticamente al arrancar el sistema. | `systemctl enable <servicio>`  | `systemctl enable nginx` |
| Ver estado            | Muestra el estado actual y últimos logs.                          | `systemctl status <servicio>`  | `systemctl status nginx` |
| Detener servicio      | Detiene el servicio sin deshabilitarlo.                           | `systemctl stop <servicio>`    | `systemctl stop nginx`   |
| Reiniciar servicio    | Reinicia el servicio sin reiniciar el sistema.                    | `systemctl restart <servicio>` | `systemctl restart sshd` |
| Ver logs del servicio | Muestra los registros generados por el demonio.                   | `journalctl -u <servicio>`     | `journalctl -u nginx`    |

**Ejemplo completo:**

```bash
systemctl start nginx
systemctl enable nginx
systemctl status nginx
journalctl -u nginx
```

### Casos de Uso

1. **Administración Web:** iniciar y habilitar `nginx` o `httpd` tras su instalación.
2. **Diagnóstico:** usar `journalctl -xe` cuando un servicio no inicia correctamente.
3. **Automatización:** crear servicios personalizados para scripts o tareas programadas.

**Ejemplo de servicio personalizado:**

```ini
[Unit]
Description=Script de Respaldo Diario
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/backup.sh

[Install]
WantedBy=multi-user.target
```

Guardar como `/etc/systemd/system/backup.service` y activar con:

```bash
systemctl daemon-reload
systemctl enable --now backup.service
```

---

## 6.2 Configuraciones Generales

Estas configuraciones controlan el comportamiento global del sistema: zona horaria, idioma, variables regionales y parámetros de red.

### Comandos Fundamentales

```bash
timedatectl set-timezone America/Santiago
localectl set-locale LANG=es_CL.UTF-8
sysctl -w net.ipv4.ip_forward=1
```

**Explicación:**

* `timedatectl`: administra fecha, hora, sincronización NTP y zona horaria.
* `localectl`: configura idioma, formato y distribución del teclado.
* `sysctl`: modifica parámetros del kernel en tiempo real.

### Cambios Persistentes

Los parámetros aplicados con `sysctl -w` se pierden tras reiniciar, por lo que deben guardarse en:

```
/etc/sysctl.conf
```

Ejemplo:

```bash
net.ipv4.ip_forward = 1
vm.swappiness = 10
```

Para aplicar los cambios sin reiniciar:

```bash
sysctl -p
```

### Casos de Uso

1. **Servidor NAT o Router:** activar reenvío IP (`ip_forward=1`).
2. **Optimizar rendimiento:** ajustar `vm.swappiness` para priorizar RAM sobre swap.
3. **Localización:** establecer zona horaria de Chile (`America/Santiago`) y lenguaje (`es_CL.UTF-8`).

---

## 6.3 Logs

El registro de eventos del sistema permite auditar y diagnosticar problemas de seguridad, red o servicios.

### Ubicaciones Clásicas

| Archivo             | Contenido                                         |
| ------------------- | ------------------------------------------------- |
| `/var/log/messages` | Eventos generales del sistema, kernel, servicios. |
| `/var/log/secure`   | Autenticaciones y accesos SSH, sudo, su, etc.     |
| `/var/log/boot.log` | Registros del proceso de arranque.                |
| `/var/log/cron`     | Ejecuciones de tareas programadas.                |

### Journalctl: Registro Binario de systemd

**Comandos Principales:**

```bash
journalctl              # Muestra todo el log del sistema
journalctl -u nginx     # Logs solo del servicio nginx
journalctl -xe          # Eventos críticos y detallados
journalctl --since today --until now   # Filtrado por rango temporal
```

**Ejemplo de análisis:**

```bash
journalctl -u sshd --since "2025-10-17 08:00" --until "2025-10-17 12:00"
```

**Opciones útiles:**

* `-b` muestra solo los eventos del último arranque.
* `--disk-usage` indica el espacio usado por el journal.
* `--vacuum-time=7d` elimina registros con más de 7 días.

### Buenas Prácticas de Gestión de Logs

* Rotar logs regularmente (`logrotate`).
* Monitorear `/var/log/secure` ante intentos fallidos de inicio de sesión.
* Limitar el tamaño de `journalctl` editando `/etc/systemd/journald.conf`.

Ejemplo:

```ini
[Journal]
SystemMaxUse=500M
SystemMaxFileSize=50M
MaxRetentionSec=1month
```

Aplicar con:

```bash
systemctl restart systemd-journald
```

---

### Glosario

* **Unit:** unidad de systemd (servicio, socket, montaje, etc.).
* **Target:** grupo de unidades que definen un estado del sistema (ej. `multi-user.target`).
* **Daemon:** proceso que se ejecuta en segundo plano.
* **Journal:** sistema de logging binario de systemd.
* **Locale:** configuración de idioma y formato regional.

---

### Referencias

* Red Hat Enterprise Linux 9 System Administrator Guide
  [https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/)
* systemd Documentation: [https://www.freedesktop.org/wiki/Software/systemd/](https://www.freedesktop.org/wiki/Software/systemd/)
* `man systemctl`, `man journalctl`, `man timedatectl`
