# 11. Seguridad y Endurecimiento (Hardening)

El endurecimiento o **hardening** en RHEL implica aplicar configuraciones, políticas y controles que reduzcan la superficie de ataque del sistema, garantizando la integridad, confidencialidad y disponibilidad de los datos.

---

## 11.1 Firewall y SELinux

### Firewall

El **firewall** controla el tráfico entrante y saliente del sistema, definiendo qué servicios o puertos están permitidos.

```bash
firewall-cmd --add-service=http --permanent
firewall-cmd --reload
```

**Explicación:**

* Agrega el servicio HTTP (puerto 80) a la zona activa de manera permanente.
* Recarga las reglas del cortafuegos sin reiniciar el servicio.

**Comandos adicionales útiles:**

```bash
firewall-cmd --list-all
firewall-cmd --remove-service=ftp --permanent
firewall-cmd --add-port=2222/tcp --permanent
```

**Zonas comunes:**

| Zona     | Descripción                             |
| -------- | --------------------------------------- |
| public   | Conexiones externas, filtrado estricto. |
| internal | Red interna de confianza.               |
| trusted  | Todo el tráfico permitido.              |

**Verificar estado del firewall:**

```bash
systemctl status firewalld
```

---

### SELinux (Security-Enhanced Linux)

SELinux es un mecanismo de **control de acceso obligatorio (MAC)** que restringe las acciones que los procesos pueden realizar, incluso si un atacante obtiene privilegios.

```bash
getenforce
setenforce 1
```

**Explicación:**

* `getenforce`: muestra el modo actual (Enforcing, Permissive, Disabled).
* `setenforce 1`: activa el modo *enforcing* temporalmente.

**Configuración permanente:**
Editar el archivo `/etc/selinux/config`:

```
SELINUX=enforcing
```

**Modos disponibles:**

| Modo       | Descripción                                    |
| ---------- | ---------------------------------------------- |
| enforcing  | Aplica las políticas de seguridad activamente. |
| permissive | Solo registra violaciones sin bloquearlas.     |
| disabled   | Desactiva SELinux (no recomendado).            |

**Logs de SELinux:** `/var/log/audit/audit.log`

**Ejemplo práctico:** Si un servidor web no puede acceder a un directorio, revisar con:

```bash
ausearch -m avc -ts recent
```

Luego permitir el acceso legítimo:

```bash
setsebool -P httpd_can_network_connect on
```

---

## 11.2 SSH Seguro

SSH (Secure Shell) es uno de los principales vectores de ataque. Configurarlo adecuadamente refuerza la seguridad del sistema.

### Configuración recomendada

Editar `/etc/ssh/sshd_config`:

```bash
PermitRootLogin no
PasswordAuthentication no
Port 2222
ClientAliveInterval 300
MaxAuthTries 3
```

**Explicación:**

* `PermitRootLogin no`: bloquea inicio de sesión directo del usuario root.
* `PasswordAuthentication no`: fuerza el uso de claves públicas.
* `Port 2222`: cambia el puerto por defecto (22) para reducir escaneos automatizados.
* `ClientAliveInterval`: cierra sesiones inactivas tras 5 minutos.
* `MaxAuthTries`: limita intentos fallidos de autenticación.

Reiniciar el servicio SSH:

```bash
systemctl restart sshd
```

### Autenticación con Claves Públicas

Generar claves RSA de 4096 bits:

```bash
ssh-keygen -t rsa -b 4096
```

Copiar la clave al servidor:

```bash
ssh-copy-id usuario@servidor
```

**Prueba de conexión:**

```bash
ssh -p 2222 usuario@servidor
```

**Buenas prácticas:**

* Usar un usuario común con privilegios `sudo`.
* Restringir el acceso por IP en `/etc/hosts.allow` y `/etc/hosts.deny`.
* Monitorizar intentos fallidos con `journalctl -u sshd`.

---

## 11.3 Auditoría del Sistema

La auditoría permite registrar y analizar eventos críticos, accesos y modificaciones en el sistema.

### Comandos principales

Listar reglas activas:

```bash
auditctl -l
```

Reporte de autenticaciones:

```bash
aureport -au
```

Resumen de llamadas al sistema:

```bash
ausyscall --summary
```

**Logs de auditoría:** `/var/log/audit/audit.log`

**Ejemplo:** detectar intentos de modificación a `/etc/passwd`.

```bash
auditctl -w /etc/passwd -p wa -k passwd_changes
aureport -k --success no
```

**Explicación:**

* `-w`: monitorea un archivo o directorio.
* `-p wa`: vigila escritura y atributos.
* `-k`: etiqueta personalizada para rastreo.

**Usos prácticos:**

* Registrar cambios en configuraciones críticas (`/etc`, `/boot`).
* Detectar intentos fallidos de autenticación.
* Auditar accesos a datos sensibles.

---

## 11.4 Actualizaciones y Parches de Seguridad

Mantener el sistema actualizado es esencial para prevenir vulnerabilidades conocidas.

**Actualizar paquetes de seguridad:**

```bash
dnf update --security -y
```

**Listar actualizaciones pendientes:**

```bash
dnf updateinfo list security all
```

**Automatizar con systemd timer:**

```bash
dnf-automatic install --security -y
```

Configurar ejecución automática en `/etc/dnf/automatic.conf`.

---

## 11.5 Monitoreo y Detección de Intrusiones

### Comprobación de integridad de archivos (AIDE)

```bash
dnf install aide -y
aide --init
mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
```

**Verificación periódica:**

```bash
aide --check
```

### Análisis de actividad sospechosa

* Revisar `/var/log/secure` y `journalctl -xe`.
* Usar `last` y `lastb` para sesiones exitosas y fallidas.
* Configurar alertas automáticas mediante scripts o correo.

---

### Buenas Prácticas de Hardening

* Deshabilitar servicios innecesarios (`systemctl disable ...`).
* Establecer políticas de contraseñas robustas (`/etc/security/pwquality.conf`).
* Implementar bloqueo de cuentas tras intentos fallidos (`pam_faillock`).
* Limitar acceso físico y remoto.
* Usar particiones separadas para `/home`, `/tmp` y `/var` con opciones `nosuid`, `nodev`, `noexec`.
* Monitorear integridad y eventos con `auditd` + `AIDE`.

---

### Glosario

* **SELinux:** Control de acceso obligatorio de Linux.
* **firewalld:** Gestor dinámico de reglas de red.
* **SSH Hardening:** conjunto de prácticas para fortalecer acceso remoto.
* **AIDE:** Herramienta de detección de modificaciones en archivos.
* **auditd:** Demonio de auditoría del sistema.

---

### Referencias

* Red Hat Security Guide:
  [https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/)
* NSA Linux Hardening Guidelines:
  [https://www.nsa.gov/resources/everyone/csfc/](https://www.nsa.gov/resources/everyone/csfc/)
* OpenSCAP & AIDE Documentation:
  [https://www.open-scap.org/](https://www.open-scap.org/)
