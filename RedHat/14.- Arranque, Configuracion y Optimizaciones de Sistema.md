# 14. Configuración de Arranque, Ajustes del Sistema, Optimización, Automatizaciones y Scripting

La correcta configuración del arranque y el ajuste fino del sistema son esenciales para obtener estabilidad, rendimiento y administración eficiente en entornos RHEL. Este capítulo aborda desde la secuencia de arranque hasta la automatización de tareas y scripting administrativo.

---

## 14.1 Secuencia de Arranque en RHEL

El arranque moderno está gestionado por **systemd**, que reemplazó al antiguo `init`. Comprender su flujo permite diagnosticar fallas y optimizar tiempos de inicio.

**Fases del arranque:**

1. **Firmware (BIOS/UEFI):** inicializa el hardware.
2. **GRUB2:** gestor de arranque que permite seleccionar kernel.
3. **Kernel:** detecta dispositivos, monta el sistema raíz y lanza `systemd`.
4. **systemd:** inicia servicios, sockets, temporizadores y unidades según dependencias.

**Ver tiempo total de arranque:**

```bash
systemd-analyze
```

**Listar servicios más lentos:**

```bash
systemd-analyze blame
```

**Revisar dependencias de una unidad:**

```bash
systemctl list-dependencies multi-user.target
```

**Optimización:**

* Deshabilitar servicios no requeridos.
* Revisar logs de `journalctl -b` para cuellos de arranque.

---

## 14.2 Configuración de GRUB2

El archivo de configuración principal:

```
/etc/default/grub
```

**Ejemplo:**

```
GRUB_TIMEOUT=5
GRUB_CMDLINE_LINUX="rhgb quiet crashkernel=auto"
```

**Regenerar configuración:**

```bash
grub2-mkconfig -o /boot/grub2/grub.cfg
```

**Cambiar kernel por defecto:**

```bash
grubby --default-kernel
```

**Ver kernels instalados:**

```bash
grubby --info=ALL
```

**Optimización:**

* Reducir `GRUB_TIMEOUT`.
* Deshabilitar `rhgb` y `quiet` para depuración avanzada.

---

## 14.3 Ajustes del Sistema (sysctl y tunables)

El comando `sysctl` permite ajustar parámetros del kernel en tiempo real.

**Ver todos los parámetros activos:**

```bash
sysctl -a
```

**Ejemplo de ajuste temporal:**

```bash
sysctl -w net.ipv4.ip_forward=1
```

**Configuración persistente:** agregar en `/etc/sysctl.conf` o `/etc/sysctl.d/*.conf`

```
vm.swappiness = 10
net.ipv4.tcp_syncookies = 1
fs.file-max = 2097152
```

**Aplicar cambios:**

```bash
sysctl -p
```

**Uso práctico:**

* Habilitar reenvío IP para routing o NAT.
* Optimizar buffers TCP.
* Aumentar límites de descriptores de archivo para servidores de alta carga.

---

## 14.4 Optimización del Sistema

### 1. CPU y Rendimiento General

* Ver frecuencia y política de CPU:

  ```bash
  cpupower frequency-info
  ```
* Cambiar modo de rendimiento:

  ```bash
  cpupower frequency-set -g performance
  ```

### 2. Memoria y Swapping

* Ajustar prioridad de swap:

  ```bash
  sysctl -w vm.swappiness=10
  ```
* Liberar caché de página manualmente:

  ```bash
  echo 3 > /proc/sys/vm/drop_caches
  ```

### 3. Disco y E/S

* Revisar rendimiento con `iostat`.
* Habilitar `noatime` en `/etc/fstab` para reducir escrituras.
* Usar `tuned` para perfiles de rendimiento.

  ```bash
  dnf install tuned -y
  systemctl enable --now tuned
  tuned-adm list
  tuned-adm profile throughput-performance
  ```

### 4. Red

* Aumentar colas de red:

  ```bash
  sysctl -w net.core.netdev_max_backlog=4096
  sysctl -w net.ipv4.tcp_window_scaling=1
  ```

---

## 14.5 Automatización de Tareas

La automatización es clave para el mantenimiento y la eficiencia operativa. Linux ofrece varias opciones:

### 1. Cron

Ejecuta tareas en intervalos fijos.

```bash
crontab -e
0 2 * * * /usr/local/bin/backup.sh
```

### 2. systemd Timers

Alternativa moderna a `cron`, con mayor control.

```bash
[Unit]
Description=Backup diario

[Service]
ExecStart=/usr/local/bin/backup.sh

[Install]
WantedBy=timers.target
```

Archivo: `/etc/systemd/system/backup.timer`

```
[Timer]
OnCalendar=03:00
Persistent=true
```

Activar:

```bash
systemctl enable --now backup.timer
```

### 3. Anacron

Ejecuta tareas programadas en sistemas que no están siempre encendidos.

```
/etc/anacrontab
1   5   cron.daily   run-parts /etc/cron.daily
```

**Recomendaciones:**

* Usar `systemd timers` para entornos modernos.
* Registrar logs de ejecución con `journalctl -u <servicio>.service`.

---

## 14.6 Scripting en Bash para Administración

El scripting en Bash permite automatizar procesos, crear tareas recurrentes y simplificar configuraciones complejas.

**Ejemplo 1: Limpieza de Logs Antiguos**

```bash
#!/bin/bash
find /var/log -type f -mtime +7 -exec gzip {} \;
echo "Logs comprimidos correctamente el $(date)"
```

**Ejemplo 2: Monitoreo de Espacio en Disco**

```bash
#!/bin/bash
THRESHOLD=80
USAGE=$(df / | grep / | awk '{print $5}' | sed 's/%//')
if [ $USAGE -gt $THRESHOLD ]; then
  echo "Espacio en disco crítico: $USAGE%" | mail -s "Alerta de espacio" admin@empresa.cl
fi
```

**Ejemplo 3: Sincronización de Datos**

```bash
#!/bin/bash
SRC=/home/data
DST=/mnt/backup/data
rsync -av --delete $SRC $DST
```

**Buenas prácticas:**

* Usar `#!/bin/bash` y permisos ejecutables.
* Validar variables y condiciones antes de ejecutar.
* Registrar actividad en `/var/log/script.log`.

---

## 14.7 Herramientas de Optimización Adicionales

* **tuned-adm:** perfiles automáticos de rendimiento.
* **cpupower:** gestión de frecuencias y energía.
* **iotop / nmon:** monitoreo de E/S en tiempo real.
* **systemd-analyze:** diagnóstico de arranque.

**Ejemplo:** comparar perfiles de tuned

```bash
tuned-adm profile latency-performance
```

---

## 14.8 Buenas Prácticas de Mantenimiento

* Revisar servicios activos (`systemctl list-unit-files | grep enabled`).
* Mantener actualizaciones regulares (`dnf update -y`).
* Limpiar archivos temporales (`tmpwatch`, `dnf autoremove`).
* Automatizar respaldos y pruebas de restauración.
* Monitorear logs (`journalctl -p err -b`).
* Evaluar rendimiento con `sar` y `vmstat` periódicamente.

---

### Glosario

* **systemd:** gestor de inicio y servicios en RHEL.
* **tuned:** daemon de ajuste de rendimiento adaptativo.
* **sysctl:** herramienta para ajustar parámetros del kernel.
* **timer:** unidad de systemd para tareas programadas.
* **Bash script:** secuencia de comandos para automatizar tareas.

---

### Referencias

* Red Hat Enterprise Linux 9 Performance Tuning Guide
  [https://access.redhat.com/documentation/en-us/](https://access.redhat.com/documentation/en-us/)
* systemd Timers: [https://www.freedesktop.org/software/systemd/man/systemd.timer.html](https://www.freedesktop.org/software/systemd/man/systemd.timer.html)
* Bash Scripting Guide: [https://tldp.org/LDP/abs/html/](https://tldp.org/LDP/abs/html/)
