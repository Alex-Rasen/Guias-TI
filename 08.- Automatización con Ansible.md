## 8: Automatización con Ansible

### 8.1 Introducción a Ansible

Ansible es una herramienta de **automatización IT sin agentes** (agentless) que permite gestionar configuraciones, desplegar software y orquestar tareas en múltiples servidores simultáneamente mediante SSH.

* Lenguaje: YAML (declarativo, legible por humanos)
* No requiere instalar cliente en los nodos gestionados.
* Usa archivos llamados *playbooks*.

### 8.2 Instalación y configuración

```bash
dnf install ansible -y
```

Archivo de inventario principal: `/etc/ansible/hosts`

**Ejemplo:**

```ini
[web]
192.168.10.10 ansible_user=root
192.168.10.11 ansible_user=root
```

Verificar conectividad:

```bash
ansible all -m ping
```

Salida esperada:

```
192.168.10.10 | SUCCESS => {
  "changed": false,
  "ping": "pong"
}
```

---

### 8.3 Estructura de un playbook

**Ejemplo básico:**

```yaml
- name: Instalar y configurar Apache
  hosts: web
  become: yes
  tasks:
    - name: Instalar httpd
      dnf:
        name: httpd
        state: present

    - name: Iniciar servicio
      service:
        name: httpd
        state: started
        enabled: yes

    - name: Copiar archivo index
      copy:
        src: files/index.html
        dest: /var/www/html/index.html
```

**Ejecutar playbook:**

```bash
ansible-playbook apache.yml
```

---

### 8.4 Variables y plantillas (Jinja2)

Ansible permite el uso de variables y plantillas dinámicas.

**Ejemplo:**
Archivo de variables: `vars.yml`

```yaml
server_port: 8080
server_name: webserver.local
```

Plantilla Jinja2 (`templates/httpd.conf.j2`):

```
Listen {{ server_port }}
ServerName {{ server_name }}
```

Task en playbook:

```yaml
- name: Generar archivo de configuración
  template:
    src: templates/httpd.conf.j2
    dest: /etc/httpd/conf/httpd.conf
```

---

### 8.5 Roles en Ansible

**Finalidad:** organizar tareas, variables, archivos y plantillas en una estructura modular reutilizable.

**Estructura estándar:**

```
roles/
  apache/
    tasks/main.yml
    handlers/main.yml
    templates/httpd.conf.j2
    files/index.html
    vars/main.yml
```

Ejemplo de rol `apache/tasks/main.yml`:

```yaml
- name: Instalar Apache
  dnf:
    name: httpd
    state: present

- name: Copiar página principal
  copy:
    src: index.html
    dest: /var/www/html/index.html
```

Playbook que usa el rol:

```yaml
- hosts: web
  become: yes
  roles:
    - apache
```

---

### 8.6 Módulos comunes de Ansible

| Módulo     | Función                                    | Ejemplo                                                              |
| ---------- | ------------------------------------------ | -------------------------------------------------------------------- |
| `dnf`      | Gestiona paquetes.                         | `dnf: name=nginx state=present`                                      |
| `service`  | Controla servicios systemd.                | `service: name=nginx state=restarted`                                |
| `copy`     | Copia archivos locales al servidor remoto. | `copy: src=file.txt dest=/tmp/`                                      |
| `template` | Genera archivos con variables.             | `template: src=config.j2 dest=/etc/config`                           |
| `user`     | Crea o modifica usuarios.                  | `user: name=juan state=present`                                      |
| `file`     | Cambia permisos o crea carpetas.           | `file: path=/backup state=directory mode=0755`                       |
| `cron`     | Programa tareas.                           | `cron: name="backup" minute=0 hour=3 job="/usr/local/bin/backup.sh"` |

---

### 8.7 Automatización avanzada

**Ejemplo: Configurar múltiples servidores con un solo comando**

```yaml
- name: Configurar red y firewall
  hosts: all
  become: yes
  tasks:
    - name: Configurar hostname
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Abrir puerto 80
      firewalld:
        port: 80/tcp
        permanent: yes
        state: enabled
        immediate: yes
```

**Resultado:** Todos los nodos en el inventario tendrán nombre único y el puerto 80 habilitado en el firewall.

---

### 8.8 Uso de Handlers

Los *handlers* son tareas que solo se ejecutan cuando algo cambia.

**Ejemplo:**

```yaml
- name: Copiar archivo de configuración
  copy:
    src: config.conf
    dest: /etc/myapp/config.conf
  notify: Reiniciar servicio

handlers:
  - name: Reiniciar servicio
    service:
      name: myapp
      state: restarted
```

---

### 8.9 Ejemplo completo de despliegue automatizado

```yaml
- name: Despliegue de aplicación completa
  hosts: web
  become: yes
  vars:
    app_dir: /var/www/html
  tasks:
    - name: Instalar dependencias
      dnf:
        name:
          - httpd
          - php
        state: present

    - name: Copiar aplicación
      copy:
        src: app/*
        dest: "{{ app_dir }}"

    - name: Configurar servicio
      template:
        src: apache.conf.j2
        dest: /etc/httpd/conf.d/app.conf
      notify: Reiniciar Apache

  handlers:
    - name: Reiniciar Apache
      service:
        name: httpd
        state: restarted
```

**Objetivo:** Instalar Apache + PHP, copiar archivos de una app y reiniciar el servicio automáticamente.

---

### 8.10 Ejecución selectiva y comprobación

* Ejecutar un solo *tag*:

  ```bash
  ansible-playbook setup.yml --tags "firewall"
  ```
* Ver modo simulación (*dry-run*):

  ```bash
  ansible-playbook setup.yml --check
  ```

---

### 8.11 Buenas prácticas

* Usar roles reutilizables para separar responsabilidades.
* Versionar los playbooks en Git.
* Probar cambios en entornos de staging antes de producción.
* Documentar cada tarea con descripciones claras.
